#!/bin/bash
#
# Copyright 2011 Raphael Bastos, Belo Horizonte, Minas Gerais, Brasil
# All rights reserved.
#
# Redistribution and use of this script, with or without modification, is 
# permitted provided that the following conditions are met:
#
# 1. Redistributions of this script must retain the above copyright
#    notice, this list of conditions and the following disclaimer.
#
#  THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR IMPLIED
#  WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF 
#  MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  IN NO
#  EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, 
#  SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
#  PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;
#  OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, 
#  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR 
#  OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF 
#  ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
#
# Este e um instalador modificado a partir do instalador da distribuicao SLACKWARE LINUX 1337
#
# As always, bug reports, suggestions, etc: yaxkin@hackstore.com.br
#
#
export LANG=pt_BR
export LC_ALL=pt_BR
export HISTTIMEFORMAT="%h/%d <96> %H:%M:%S <96> "

var=0
# Define diretorio temporario do instalador
TMP="/mnt/setup/tmp"
if [ ! -d $TMP ]; then
  mkdir -p $TMP
fi

INSTALL_DIR="/mnt/yaxkin"
if [ ! -d $INSTALL_DIR= ]; then
  mkdir -p $INSTALL_DIR
  fi

# Limpando diretorio tmp
rm -f $TMP/SeT*


# If a keymap was set up, restore that data:
if [ -r $TMP/Pkeymap ]; then
  cp $TMP/Pkeymap $TMP/SeTkeymap
fi
echo "on" > $TMP/SeTcolor # turn on color menus
PATH="$PATH:/mnt/setup"
export PATH;
export COLOR=on

# Before probing, activate any LVM partitions
# that may exist from before the boot:
vgchange -ay 1> /dev/null 2> /dev/null
if fdisk -l 2> /dev/null | egrep -i 'Linux$' 1> /dev/null 2> /dev/null ; then
 fdisk -l 2> /dev/null | egrep -i 'Linux$' | sort 1> $TMP/SeTplist 2> /dev/null

else

dialog --title " NENHUMA PARTIÇÃO LINUX DETECTADA " \
--msgbox " Parece que não existe nenhuma partição Linux nesta máquina. \
Você precisará criar pelo menos uma para instalar o Yaxkin Linux. \n\
Para fazer isso, você precisa sair do 'setup', e criar as partições usando o \
'cfdisk' ou 'fdisk'. Para mais informações, leia o HELP \
no menu a seguir. \n\n\
Lembre-se também de criar uma partição SWAP de pelo menos 2GB. " 13 60

fi

T_PX="/mnt/yaxkin"

echo "$T_PX" > $TMP/SeTT_PX

ROOT_DEVICE="`mount | egrep -i "on /mnt/yaxkin " | cut -f 1 -d ' '`"

echo "$ROOT_DEVICE" > $TMP/SeTrootdev

if mount | egrep -i /tmp/mount 1> /dev/null 2> /dev/null ; then # clear source
 umount /tmp/mount                                           # location
fi

# Anything mounted on /tmp/mount now is a fatal error:
if mount | egrep -i /tmp/mount 1> /dev/null 2> /dev/null ; then
  echo "Can't umount /tmp/mount.  Reboot machine and run setup again."
  exit
fi
# If the mount table is corrupt, the above might not do it, so we will
# try to detect Linux and FAT32 partitions that have slipped by:
if [ -d /tmp/mount/lost+found -o -d /tmp/mount/recycled \
     -o -r /tmp/mount/io.sys ]; then
  echo "Mount table corrupt.  Reboot machine and run setup again."
  exit
fi
rm -f /tmp/mount 2> /dev/null
rmdir /tmp/mount 2> /dev/null
mkdir /tmp/mount 2> /dev/null

while [ 0 ]; do

 dialog --title " Yaxkin Linux Setup " \
--menu \
"Bem vindo ao instalador do Yaxkin Linux.\n\n\
Selecione uma opção usando as teclas direcionais UP/DOWN e pressione SPACE ou ENTER.\n\
Teclas alternativas tambem podem ser usadas: '+', '-' e TAB." 0 0 0 \
"HELP" "Leia os arquivos de ajuda do instalador do Yaxkin" \
"KEYMAP" "Redefina seu mapa de teclado" \
"ADDSWAP" "Configure a partição SWAP" \
"TARGET" "Configure a partição destino da instalação" \
"SOURCE" "Defina a fonte da instalação" \
"INSTALAR" "Instale o Yaxkin" \
"CONFIGURE" "---- sem definição ----" \
"HORA" "Defina a hora do sistema" \
"EXIT" "Sair do instalador do Yaxkin Linux" 2> $TMP/hdset



if [ ! $? = 0 ]; then
  rm -f $TMP/hdset $TMP/SeT*
  exit
 fi
 MAINSELECT="`cat $TMP/hdset`"
 rm $TMP/hdset

# Inicio do script de instalação

################################################################
# HELP


 if [ "$MAINSELECT" = "HELP" ]; then
  SeTfdHELP
 fi

################################################################
# MAPA DE TECLADO

 if [ "$MAINSELECT" = "KEYMAP" ]; then
  SeTkeymap
  if [ -r $TMP/SeTkeymap ]; then
   MAINSELECT="ADDSWAP" 
  fi
 fi
 
 if [ "$MAINSELECT" = "MAKE TAGS" ]; then
  SeTmaketag
 fi

################################################################
# SWAP - OK e traduzido

 if [ "$MAINSELECT" = "ADDSWAP" ]; then
  SeTswap
  if [ -r $TMP/SeTswap ]; then
   MAINSELECT="TARGET"
  elif [ -r $TMP/SeTswapskip ]; then
   # Go ahead to TARGET without swap space:
   MAINSELECT="TARGET"
  fi
 fi

################################################################
# TARGET - OK falta traduzir

if [ "$MAINSELECT" = "TARGET" ]; then
  SeTpartitions

var=0
touch $TMP/SeTnative
var=$(wc -l $TMP/SeTnative|cut -d" " -f1)

if [ "$var" -ge 1 ];then 
   MAINSELECT="SOURCE"
fi
 fi
################################################################
# SOURCE - OK e traduzido

 if [ "$MAINSELECT" = "SOURCE" ]; then
var=0
touch $TMP/SeTnative
var=$(wc -l $TMP/SeTnative|cut -d" " -f1) 
if [ "$var" -ge 1 ];then 
	SeTselecionado
else
      dialog --title " ERRO AO SELECIONAR YAXKIN " --msgbox "\n \
   O instalador do Yaxkin precisa de algumas coisas:\n\n \
      1. Selecione pelo menos uma partição Linux previamente criada.\n \
      2. Se possível crie e ative uma partição SWAP (RECOMENDADO).\n
      \n
      Caso deseje, redefina o mapa de teclado.\n\n
      Pressione ENTER para retornar ao menu principal." 14 78

      fi


  if [ -r $TMP/SeTselecionado ]; then
   MAINSELECT="INSTALAR"
  fi
 fi

################################################################
# INSTALL SCRIPT

 if [ "$MAINSELECT" = "INSTALAR" ]; then
  
  if [ ! -r $TMP/SeTselecionado -o ! -r $TMP/SeTnative ]; then

     dialog --title " ERRO AO INSTALAR YAXKIN " --msgbox "\n \
  O instalador do Yaxkin precisa de algumas coisas:\n\n \
     1. Selecione pelo menos uma partição Linux previamente criada.\n \
     2. Se possível crie e ative uma partição SWAP (RECOMENDADO).\n
     \n
     Caso deseje, redefina o mapa de teclado.\n\n
     Pressione ENTER para retornar ao menu principal." 14 78
     continue
       fi


# inicio da instalação em si....
#setup-old-slackware-install
setup-install
fi

#######################################################3
# CONFIGURE

 if [ "$MAINSELECT" = "CONFIGURE" ]; then
#SeTconfigure
echo "bla" > /dev/null
  if [ -r $TMP/fstab ]; then
   MAINSELECT="HORA"
  fi
 fi

#######################################################
# configura hora do Yaxkin

 if [ "$MAINSELECT" = "HORA" ]; then
  fixdate  
  if [ -r $TMP/fixdate ]; then
   MAINSELECT="EXIT"
  fi
 fi



 if [ "$MAINSELECT" = "EXIT" ]; then
  break
 fi

done # end of main loop
sync

chmod 755 $T_PX
if [ -d $T_PX/tmp ]; then
 chmod 1777 $T_PX/tmp
fi
if mount | egrep -i /tmp/mntiso 1> /dev/null 2> /dev/null ; then
 umount -f /tmp/mntiso
fi
if mount | egrep -i /tmp/mount 1> /dev/null 2> /dev/null ; then
 umount /tmp/mount
fi
# Anything mounted on /tmp/mount now is a fatal error:
if mount | egrep -i /tmp/mount 1> /dev/null 2> /dev/null ; then
  exit
fi
# If the mount table is corrupt, the above might not do it, so we will
# try to detect Linux and FAT32 partitions that have slipped by:
if [ -d /tmp/mount/lost+found -o -d /tmp/mount/recycled \
     -o -r /tmp/mount/io.sys ]; then
  exit
fi
rm -f /tmp/mount 2> /dev/null
rmdir /tmp/mount 2> /dev/null
mkdir /tmp/mount 2> /dev/null
chmod 755 /tmp/mount

if [ -f /mnt/etc/fstab ]; then
  echo
  echo "Yaxkin Linux instalado com sucesso."
  echo
  # umount CD:
  if [ -r $TMP/SeTCDdev ]; then
    if mount | egrep -i iso9660 > /dev/null 2> /dev/null ; then
      umount `mount | egrep -i iso9660 | cut -f 1 -d ' '`
    fi
    eject `cat $TMP/SeTCDdev`
    echo "Please remove the installation disc and press ctrl-alt-delete to reboot."
  else
    echo "You may now press ctrl-alt-delete to reboot."
  fi
  echo
fi

# Fix the date:
#./fixdate

# final cleanup
rm -f $TMP/tagfile $TMP/SeT* $TMP/tar-error $TMP/PKGTOOL_REMOVED
rm -f /tmp/mount/treecache
rmdir /tmp/mntiso 2>/dev/null
rm -rf $TMP/treecache
rm -rf $TMP/pkgcache
rmdir /mnt/tmp/orbit-root 2> /dev/null
# end yaxkin setup script

